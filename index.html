<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>無限英文單字挑戰賽 - 網頁版</title>
    <!-- 1. 引入 Tailwind CSS 進行樣式渲染 -->
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <!-- 2. 引入 React 核心庫 -->
    <script src="[https://unpkg.com/react@18/umd/react.production.min.js](https://unpkg.com/react@18/umd/react.production.min.js)"></script>
    <script src="[https://unpkg.com/react-dom@18/umd/react-dom.production.min.js](https://unpkg.com/react-dom@18/umd/react-dom.production.min.js)"></script>
    <!-- 3. 引入 Babel 以便在瀏覽器解析 JSX -->
    <script src="[https://unpkg.com/@babel/standalone/babel.min.js](https://unpkg.com/@babel/standalone/babel.min.js)"></script>
    <!-- 4. 引入 Lucide 圖標庫 -->
    <script src="[https://unpkg.com/lucide@latest](https://unpkg.com/lucide@latest)"></script>
    
    <style>
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        .animate-shake { animation: shake 0.2s ease-in-out 0s 2; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <!-- 5. 核心程式碼區域 -->
    <script type="text/babel">
        // --- Firebase 配置說明 ---
        // 注意：如果你要在自己的網址運行，請更換下方的配置為你自己的 Firebase Project 資訊
       const firebaseConfig = {
  apiKey: "AIzaSyD0ilDtY1tcifDHN-e8rkrTsBzbwT9ERBc",
  authDomain: "englishtest-1eaad.firebaseapp.com",
  projectId: "englishtest-1eaad",
  storageBucket: "englishtest-1eaad.firebasestorage.app",
  messagingSenderId: "1062016486474",
  appId: "1:1062016486474:web:f21824c41e0759b7dd6ab3",
  measurementId: "G-FJ90HSV5Q5"
};

        // 引入 Firebase 模組
        import { initializeApp } from "[https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js](https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js)";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, setDoc, getDocs, deleteDoc, writeBatch } from "[https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js](https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js)";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "[https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js](https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js)";

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const { useState, useEffect, useCallback, useMemo } = React;

        // 預設備援單字
        const DEFAULT_VOCAB = [
            { ch: "打", en: "hit" },
            { ch: "吃", en: "eat" },
            { ch: "跑", en: "run" }
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('login'); 
            const [playerName, setPlayerName] = useState('');
            const [vocabList, setVocabList] = useState([]);
            const [loading, setLoading] = useState(true);
            const [currentQuestion, setCurrentQuestion] = useState(null);
            const [userInput, setUserInput] = useState('');
            const [score, setScore] = useState(0);
            const [timeLeft, setTimeLeft] = useState(300); 
            const [gameRecords, setGameRecords] = useState([]);
            const [feedback, setFeedback] = useState(null);
            const [newCh, setNewCh] = useState('');
            const [newEn, setNewEn] = useState('');

            // A. 身份驗證
            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            // B. 實時資料監聽
            useEffect(() => {
                if (!user) return;
                const vocabRef = collection(db, 'artifacts', appId, 'public', 'data', 'vocabulary');
                const unsubVocab = onSnapshot(vocabRef, (snapshot) => {
                    const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setVocabList(list);
                    setLoading(false);
                });
                const recordsRef = collection(db, 'artifacts', appId, 'public', 'data', 'records');
                const unsubRecords = onSnapshot(recordsRef, (snapshot) => {
                    const records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    records.sort((a, b) => b.timestamp - a.timestamp);
                    setGameRecords(records);
                });
                return () => { unsubVocab(); unsubRecords(); };
            }, [user]);

            // C. 重新渲染 Lucide 圖標
            useEffect(() => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, [view, vocabList, gameRecords, loading]);

            const pickNewQuestion = useCallback(() => {
                const source = vocabList.length > 0 ? vocabList : DEFAULT_VOCAB;
                const randomIndex = Math.floor(Math.random() * source.length);
                setCurrentQuestion(source[randomIndex]);
            }, [vocabList]);

            useEffect(() => {
                let timer;
                if (view === 'game' && timeLeft > 0) {
                    timer = setInterval(() => setTimeLeft(p => p <= 1 ? 0 : p - 1), 1000);
                } else if (timeLeft === 0 && view === 'game') {
                    endGame();
                }
                return () => clearInterval(timer);
            }, [view, timeLeft]);

            const startGame = () => {
                if (!playerName.trim()) return;
                setScore(0); setTimeLeft(300); setUserInput('');
                pickNewQuestion(); setView('game');
            };

            const endGame = async () => {
                setView('result');
                if (!user) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'records'), {
                    name: playerName, score, timestamp: Date.now(), dateString: new Date().toLocaleString()
                });
            };

            const handleAnswer = (e) => {
                e.preventDefault();
                if (userInput.toLowerCase().trim() === currentQuestion.en.toLowerCase()) {
                    setScore(s => s + 1); setFeedback('correct');
                    setTimeout(() => { setFeedback(null); setUserInput(''); pickNewQuestion(); }, 400);
                } else {
                    setFeedback('wrong'); setTimeout(() => setFeedback(null), 800);
                }
            };

            const handleCSVUpload = (e) => {
                const file = e.target.files[0];
                if (!file || !user) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    let text = event.target.result;
                    if (text.charCodeAt(0) === 0xFEFF) text = text.substr(1);
                    const lines = text.split(/\r?\n/);
                    const batch = writeBatch(db);
                    let count = 0;
                    lines.forEach(line => {
                        const parts = line.split(',').map(p => p.replace(/^"|"$/g, '').trim());
                        if (parts[0] && parts[1] && parts[0] !== 'ch' && parts[0] !== '中文題目') {
                            const en = parts[1].toLowerCase();
                            batch.set(doc(db, 'artifacts', appId, 'public', 'data', 'vocabulary', en), { ch: parts[0], en });
                            count++;
                        }
                    });
                    if (count > 0) { await batch.commit(); alert(`成功同步 ${count} 個單字！`); }
                };
                reader.readAsText(file, "UTF-8");
            };

            return (
                <div className="min-h-screen">
                    {view === 'login' && (
                        <div className="min-h-screen flex flex-col items-center justify-center p-4">
                            <div className="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md text-center border-t-[10px] border-indigo-600">
                                <div className="bg-indigo-100 w-24 h-24 rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-inner">
                                    <i data-lucide="zap" className="text-indigo-600 w-12 h-12 fill-indigo-600"></i>
                                </div>
                                <h1 className="text-3xl font-black mb-2 text-slate-800 tracking-tight">無限單字挑戰</h1>
                                <p className="text-slate-400 mb-10 font-bold uppercase tracking-widest text-xs">300s Vocabulary Sprint</p>
                                <input 
                                    type="text" placeholder="你的挑戰暱稱" 
                                    className="w-full px-6 py-4 rounded-2xl border-2 border-slate-50 bg-slate-50 focus:bg-white focus:border-indigo-500 outline-none transition-all font-black text-center text-xl mb-6 shadow-sm"
                                    value={playerName} onChange={e => setPlayerName(e.target.value)}
                                />
                                <button 
                                    disabled={loading}
                                    onClick={startGame} 
                                    className="w-full bg-indigo-600 disabled:bg-slate-300 text-white py-5 rounded-2xl font-black text-2xl shadow-xl shadow-indigo-200 hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-3"
                                >
                                    {loading ? <i data-lucide="loader-2" className="animate-spin"></i> : "立即開戰"}
                                </button>
                                <button onClick={() => setView('admin')} className="mt-10 text-slate-300 hover:text-indigo-600 flex items-center justify-center gap-2 mx-auto text-sm font-bold transition-colors">
                                    <i data-lucide="settings" className="w-4 h-4"></i> 後台管理
                                </button>
                            </div>
                        </div>
                    )}

                    {view === 'game' && (
                        <div className="min-h-screen bg-indigo-600 p-6 flex flex-col items-center justify-center">
                            <div className="w-full max-w-2xl flex justify-between items-center text-white mb-8 font-black italic tracking-tighter">
                                <div className="bg-black/20 backdrop-blur-md px-5 py-3 rounded-2xl border border-white/10 flex items-center gap-3">
                                    <i data-lucide="user" className="w-5 h-5"></i> {playerName}
                                </div>
                                <div className={`px-8 py-3 rounded-2xl border-4 ${timeLeft < 30 ? 'bg-red-500 border-white animate-pulse' : 'bg-black/20 border-white/20'}`}>
                                    TIME: {timeLeft}S
                                </div>
                                <div className="bg-yellow-400 text-indigo-950 px-8 py-3 rounded-2xl shadow-[6px_6px_0px_0px_rgba(0,0,0,0.15)]">
                                    SCORE: {score}
                                </div>
                            </div>

                            <div className="bg-white w-full max-w-2xl rounded-[3.5rem] shadow-2xl p-12 md:p-20 text-center relative overflow-hidden border-b-[16px] border-slate-200">
                                <div className="mb-6 text-indigo-400 font-black tracking-[0.4em] text-xs">INFINITE MODE</div>
                                <div className="text-[7rem] md:text-[9rem] font-black text-slate-800 leading-none mb-12 select-none">
                                    {currentQuestion?.ch}
                                </div>
                                <form onSubmit={handleAnswer}>
                                    <input 
                                        autoFocus type="text" value={userInput} onChange={e => setUserInput(e.target.value)}
                                        placeholder="在此輸入英文單字..."
                                        className={`w-full text-center text-5xl font-black py-8 bg-slate-50 rounded-[2.5rem] border-4 outline-none transition-all placeholder:text-slate-200 ${
                                            feedback === 'correct' ? 'border-green-500 text-green-600 bg-green-50' : 
                                            feedback === 'wrong' ? 'border-red-500 text-red-600 bg-red-50 animate-shake' : 'border-slate-100 focus:border-indigo-500'
                                        }`}
                                    />
                                </form>
                                {feedback === 'correct' && (
                                    <div className="absolute inset-0 flex items-center justify-center bg-green-500/10 backdrop-blur-[2px] pointer-events-none">
                                        <div className="bg-white p-10 rounded-full shadow-2xl animate-bounce">
                                            <i data-lucide="check-circle-2" className="w-20 h-20 text-green-500"></i>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {view === 'result' && (
                        <div className="min-h-screen bg-indigo-950 flex flex-col items-center justify-center p-6 text-white text-center">
                            <i data-lucide="trophy" className="w-32 h-32 text-yellow-400 mb-8 drop-shadow-[0_0_20px_rgba(250,204,21,0.5)]"></i>
                            <h2 className="text-6xl font-black mb-4 italic tracking-tighter">挑戰結束！</h2>
                            <p className="text-indigo-300 font-bold mb-12 tracking-widest uppercase">{playerName} 的挑戰最終得分</p>
                            <div className="bg-white/5 backdrop-blur-xl border border-white/10 p-16 rounded-[4rem] mb-16 shadow-inner">
                                <div className="text-xl font-bold text-indigo-200 uppercase tracking-widest mb-4">Total Score</div>
                                <div className="text-[12rem] font-black leading-none">{score}</div>
                            </div>
                            <div className="flex gap-6 w-full max-w-md">
                                <button onClick={startGame} className="flex-1 bg-yellow-400 text-indigo-950 py-6 rounded-3xl font-black text-2xl hover:bg-yellow-300 transition-all shadow-lg shadow-yellow-900/20">再戰一次</button>
                                <button onClick={() => setView('login')} className="flex-1 bg-white/10 py-6 rounded-3xl font-black text-2xl border border-white/20 hover:bg-white/20 transition-all">結束</button>
                            </div>
                        </div>
                    )}

                    {view === 'admin' && (
                        <div className="max-w-6xl mx-auto p-8 md:p-12">
                            <div className="flex items-center justify-between mb-12">
                                <button onClick={() => setView('login')} className="flex items-center gap-3 text-slate-500 font-black hover:text-indigo-600 transition-colors">
                                    <i data-lucide="arrow-left" className="w-6 h-6"></i> 返回首頁
                                </button>
                                <h1 className="text-3xl font-black text-slate-800">題庫中心與挑戰紀錄</h1>
                                <div className="w-24"></div>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-10">
                                <div className="space-y-8">
                                    <div className="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100">
                                        <h3 className="font-black text-xl mb-6 flex items-center gap-3 text-indigo-600"><i data-lucide="plus"></i> 單筆更新</h3>
                                        <input type="text" placeholder="中文解釋" className="w-full p-4 border-2 border-slate-50 rounded-2xl mb-3 focus:border-indigo-500 outline-none font-bold" value={newCh} onChange={e=>setNewCh(e.target.value)}/>
                                        <input type="text" placeholder="英文單字" className="w-full p-4 border-2 border-slate-50 rounded-2xl mb-6 focus:border-indigo-500 outline-none font-bold" value={newEn} onChange={e=>setNewEn(e.target.value)}/>
                                        <button onClick={async ()=>{
                                            if(!newCh || !newEn) return;
                                            const en = newEn.trim().toLowerCase();
                                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'vocabulary', en), { ch: newCh.trim(), en });
                                            setNewCh(''); setNewEn('');
                                        }} className="w-full bg-slate-800 text-white py-4 rounded-2xl font-black hover:bg-black transition-all">執行同步</button>
                                    </div>
                                    <div className="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100">
                                        <h3 className="font-black text-xl mb-2 flex items-center gap-3 text-green-600"><i data-lucide="upload"></i> CSV 智慧匯入</h3>
                                        <p className="text-[10px] text-slate-400 mb-6 font-bold uppercase tracking-widest leading-relaxed">Excel 另存 CSV 時請務必選擇 UTF-8 格式。</p>
                                        <label className="block w-full border-4 border-dashed border-slate-100 rounded-[2.5rem] p-10 text-center cursor-pointer hover:border-indigo-200 transition-all bg-slate-50">
                                            <input type="file" accept=".csv" className="hidden" onChange={handleCSVUpload} />
                                            <i data-lucide="file-text" className="mx-auto text-slate-300 mb-4 w-12 h-12"></i>
                                            <span className="text-sm font-black text-slate-400 uppercase">Upload CSV</span>
                                        </label>
                                    </div>
                                </div>

                                <div className="lg:col-span-2 space-y-8">
                                    <div className="bg-white rounded-[3rem] shadow-xl border border-slate-100 p-8">
                                        <h3 className="font-black text-xl mb-6 flex items-center gap-3"><i data-lucide="refresh-cw"></i> 雲端單字清單 ({vocabList.length})</h3>
                                        <div className="max-h-[400px] overflow-y-auto pr-2 custom-scrollbar grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {vocabList.map(v => (
                                                <div key={v.id} className="flex justify-between items-center p-5 bg-slate-50 rounded-[1.5rem] border border-transparent hover:border-indigo-100 transition-all group">
                                                    <div className="flex flex-col">
                                                        <span className="text-[10px] font-black text-slate-300">ID: {v.id}</span>
                                                        <div className="flex items-center gap-4 mt-1">
                                                            <span className="font-black text-slate-800">{v.ch}</span>
                                                            <span className="text-indigo-600 font-mono font-bold tracking-tight">{v.en}</span>
                                                        </div>
                                                    </div>
                                                    <button onClick={async ()=>await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'vocabulary', v.id))} className="text-slate-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100">
                                                        <i data-lucide="trash-2" className="w-5 h-5"></i>
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="bg-white rounded-[3rem] shadow-xl border border-slate-100 p-8">
                                        <h3 className="font-black text-xl mb-6 flex items-center gap-3"><i data-lucide="history"></i> 即時玩家數據</h3>
                                        <div className="max-h-[250px] overflow-y-auto custom-scrollbar space-y-3">
                                            {gameRecords.map(r => (
                                                <div key={r.id} className="flex justify-between items-center p-4 bg-slate-900 rounded-3xl text-white">
                                                    <span className="font-black text-lg">{r.name}</span>
                                                    <div className="flex items-center gap-6">
                                                        <span className="text-yellow-400 font-black text-2xl">{r.score}</span>
                                                        <span className="text-slate-500 text-[10px] font-bold uppercase">{r.dateString}</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>